@page "/register"

<PageTitle>BSLR: Register</PageTitle>

<div class="mask d-flex align-items-center h-100">
    <div class="container h-100">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-12 col-md-9 col-lg-7 col-xl-6">
                <div class="card" style="border-radius: 15px;">
                    <div class="card-body p-5">

                        <EditForm EditContext="_context" OnValidSubmit="Submit" FormName="AccountRegistration">
                            <DataAnnotationsValidator />

                            <h2 class="text-uppercase text-center mb-5">Create an account</h2>

                            <div class="form-outline mb-4">
                                <label class="form-label" for="Input_Email">Email</label>
                                <InputText tabindex="1" type="email" id="Input_Email" class="form-control form-control-lg" @ref="_emailInput" @bind-Value="_model.Email" />
                                <ValidationMessage For="@(() => _model.Email)" />
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-outline mb-4 me-2 flex-fill">
                                    <label for="Input_FirstName" class="form-label">First Name</label>
                                    <InputText tabindex="2" id="Input_FirstName" class="form-control form-control-lg" @bind-Value="_model.FirstName" />
                                    <ValidationMessage For="@(() => _model.FirstName)" />
                                </div>

                                <div class="form-outline mb-4 ms-2 flex-fill">
                                    <label for="Input_LastName" class="form-label">Last Name</label>
                                    <InputText tabindex="3" id="Input_LastName" class="form-control form-control-lg" @bind-Value="_model.LastName" />
                                    <ValidationMessage For="@(() => _model.FirstName)" />
                                </div>
                            </div>

                            <div class="form-outline mb-4">
                                <label class="form-label" for="Input_Password">Password</label>
                                <InputText tabindex="4" type="password" id="Input_Password" class="form-control form-control-lg" @bind-Value="_model.Password" />
                                <ValidationMessage For="@(() => _model.Password)" />
                            </div>

                            <div class="form-outline mb-4">
                                <label class="form-label" for="Input_ConfirmPassword">Repeat your password</label>
                                <InputText tabindex="5" type="password" id="Input_ConfirmPassword" class="form-control form-control-lg" @bind-Value="_model.ConfirmPassword" />
                                <ValidationMessage For="@(() => _model.ConfirmPassword)" />
                            </div>

                            <div class="d-flex justify-content-center">
                                <button tabindex="7" type="reset" class="btn btn-outline-primary btn-block btn-lg me-2" @onclick="Reset">Reset</button>
                                <button tabindex="6" type="submit" class="btn btn-primary btn-block btn-lg text-body ms-2">Register</button>
                            </div>

                            <p class="text-center text-muted mt-5 mb-0">Have already an account? <a href="login" class="link fw-bold text-decoration-underline">Login here</a></p>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private FormModel _model { get; set; } = new();
    private EditContext? _context;
    private InputText _emailInput = default!;

    private class FormModel
    {
        [Required(ErrorMessage = "Email is required!")]
        [EmailAddress]
        public string? Email { get; set; }

        [Required(ErrorMessage = "First name is required!")]
        [MinLength(2), MaxLength(50)]
        public string? FirstName { get; set; }

        [Required(ErrorMessage = "Last name is required!")]
        [MinLength(2), MaxLength(50)]
        public string? LastName { get; set; }

        [Required(ErrorMessage = "Password is required!")]
        [MinLength(8), MaxLength(50)]
        public string? Password { get; set; }

        [Required(ErrorMessage = "Re-enter your password!"), Compare(nameof(Password), ErrorMessage = "Passwords to not match!")]
        public string? ConfirmPassword { get; set; }
    }

    protected override void OnInitialized() => _context = new(_model);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _emailInput?.Element is not null)
            await _emailInput.Element.Value.FocusAsync();
    }

    private void Reset()
    {
        _model = new FormModel();
        _context = new(_model);
    }

    private void Submit()
    {
        var request = new RegisterAccountRequest(_model.Email!, _model.FirstName!, _model.LastName!, _model.Password!);
        _model.Password = null;
        _model.ConfirmPassword = null;

        Log.Information("Submit called: Processing the form\n{@Request}", request);
    }
}
